<!DOCTYPE html>
<html class="no-js" lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1da1f2">
	<title>You are mocking it wrong. |  Anton Sizikov </title>
	<meta name="description"
		content="Well, probably you are not, but let me grumble a little bit anyway.">
	<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.cloud-eng.nl/img/avatar.webp"/>

<meta name="twitter:title" content="You are mocking it wrong."/>
<meta name="twitter:description" content="Well, probably you are not, but let me grumble a little bit anyway."/>

	<meta name="twitter:site" content="@return_true" />
	<meta itemprop="name" content="You are mocking it wrong.">
<meta itemprop="description" content="Well, probably you are not, but let me grumble a little bit anyway."><meta itemprop="datePublished" content="2017-12-23T00:00:00+00:00" />
<meta itemprop="dateModified" content="2017-12-23T00:00:00+00:00" />
<meta itemprop="wordCount" content="1523"><meta itemprop="image" content="https://blog.cloud-eng.nl/img/avatar.webp"/>
<meta itemprop="keywords" content="programming," />
	<link rel="stylesheet" href="/css/bundle.min.css">
	<link rel="apple-touch-icon" sizes="180x180" href="https://blog.cloud-eng.nl/icons/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://blog.cloud-eng.nl/icons/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://blog.cloud-eng.nl/icons/favicon-16x16.png">
	<link rel="shortcut icon" href="https://blog.cloud-eng.nl/icons/favicon.ico" type="image/x-icon">
	<link rel="icon" href="https://blog.cloud-eng.nl/icons/favicon.ico" type="image/x-icon">
	<meta name="msapplication-TileColor" content="#1da1f2">
	<link rel="manifest" href="https://blog.cloud-eng.nl/manifest.json">
	
	<script type="application/ld+json">
{
	"@context":"http://schema.org",
	"@type":"WebSite",
	"name":"Anton Sizikov",
	"url":"https:\/\/blog.cloud-eng.nl\/",
	"sameAs":[
		"https://twitter.com/return_true",
		"https://gitlab.com/",
		"https://linkedin.com/in/sizikov",
		"https://t.me/"
		],
	"potentialAction": {
		"@type": "SearchAction",
		"target": "https://wisnuwiry.space/search?q={search_term}",
		"query-input": "required name=search_term"
	}
}
</script>

<script type='application/ld+json'>
{
	"@context": "http://www.schema.org",
	"@type": "person",
	"name": "",
	"jobTitle": "",
	"gender": "",
	"url": "https:\/\/blog.cloud-eng.nl\/",
	"sameAs":[
		"https://twitter.com/return_true",
		"https://gitlab.com/",
		"https://linkedin.com/in/sizikov",
		"https://t.me/"
		],
	"image": "https:\/\/blog.cloud-eng.nl\/img\/avatar.jpeg",
	"address": {
		"@type": "PostalAddress",
		"streetAddress": "Mayong, Jepara",
		"addressLocality": "Jepara",
		"addressRegion": "Jawa Tengah",
		"addressCountry": "Indonesia"
	},
	"email": "",
	"birthDate": "2003-01-31",
	"birthPlace": "Jepara",
	"nationality": "Indonesian"
}
</script>

<script type="application/ld+json">
{
	"@context":"http://schema.org",
	"@type":"BlogPosting",
	"mainEntityOfPage":{
		"@type":"WebPage",
		"@id":"https:\/\/blog.cloud-eng.nl\/https:\/\/blog.cloud-eng.nl\/2017\/12\/23\/you-are-mocking-it-wrong\/"
	},
	"headline":"You are mocking it wrong.",
	"datePublished":"2017-12-23T00",
	"dateModified":"2017-12-23T00",
	"description":"Well, probably you are not, but let me grumble a little bit anyway.",
	"isFamilyFriendly": "true",
	"image": ["https://blog.cloud-eng.nl/img/avatar.jpeg"],
	"wordCount" : "1523",
	"keywords": ["programming"],
	"genre": ["programming"],
	"accountablePerson": {
		"@type": "Person",
		"name": "",
		"url": ""
	},
	"author": {
		"@type": "Person",
		"name": "",
		"url": ""
	},
	"creator": {
		"@type": "Person",
		"name": "",
		"url": ""
	},
	"publisher":{
		"@type":"Organization",
		"name":"", 
		"logo": {
			"@type": "imageObject",
			"url": "https:\/\/blog.cloud-eng.nl\/img\/avatar.jpeg"
		}
	}
}</script>


	<meta content="" property="fb:admins">
	<meta content="" property="fb:app_id">
	<meta content="index,follow" name="googlebot">
	<meta content="follow, all" name="Googlebot-Image">
	<meta content="follow, all" name="Scooter">
	<meta content="follow, all" name="msnbot">
	<meta content="follow, all" name="alexabot">
	<meta content="follow, all" name="Slurp">
	<meta content="follow, all" name="ZyBorg">
	<meta content="follow, all" name="Scooter">
	<meta content="true" name="MSSmartTagsPreventParsing">
	<meta content="ALL" name="SPIDERS">
	<meta content="ALL" name="WEBCRAWLERS">
	<meta
		content="aeiwi, alexa, alltheWeb, altavista, aol netfind, anzwers, canada, directhit, euroseek, excite, overture, go, google, hotbot. infomak, kanoodle, lycos, mastersite, national directory, northern light, searchit, simplesearch, Websmostlinked, webtop, what-u-seek, aol, yahoo, webcrawler, infoseek, excite, magellan, looksmart, bing, cnet, googlebot"
		name="search engines">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	
</head>

<body class="">
	<div class="site-container">
		<header class="top" id="js-header">
	<a class="logo" href="/" title="Anton Sizikov">
    <img src="/img/placeholder.svg" alt="Anton Sizikov" class="lazyload" data-src="/img/avatar.jpeg">
</a>
	
	<nav class="navbar js-navbar">
		<ul class="navbar__menu">
			
			
				
				<li>
					<a href="/tags" target="_self">
						üìù Tags
					</a>
				</li>
				
				
				<li>
					<a href="/about" target="_self">
						üòÉ About
					</a>
				</li>
				
		</ul>
		<button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span>
		</button>
	</nav>
	<div class="search">
	<button class="search__btn btn" aria-label="Switch Theme" id="toggle-theme">
		<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<path id="icon-theme"></path>
		</svg>
	</button>
</div>
</header>

		<main>
			
<div class="wrapper big-wrapper featured__box featured__box__img">
	
	
	<div class="hero__content">
		<h1>You are mocking it wrong.</h1>
	</div>
	 
	<p class="property">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> <time itemprop="datePublished" datetime="2017-12-23T00:00:00Z">December 23, 2017</time> 
    </span>
    <span>¬∑</span>
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg> 8 min read
    </span>
</p>
	
</div>
	
	<article id="article" class="post__entry single grid wrapper big-wrapper">
		<div class="main">
		
		<div class="entry__toc card">
			
<div id="toc__box" class="toc__box">
    <div class="toc__list collapse">
        <h3 class="toc__title" id="toc__toggle">
            <span style="display: flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg><span style="margin-left: 20px;">TABLE OF CONTENT</span></span>
            <span class="toc__toggle"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></span>
        </h3>
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#but-integration-tests-are-slow">But integration tests are slow&hellip;</a></li>
        <li><a href="#so-youre-going-to-send-out-those-emails-every-time-you-test">So you&rsquo;re going to send out those emails every time you test?</a></li>
        <li><a href="#hey-i-tried-not-to-mock-and-i-got-sick-of-initing-all-the-dependencies">Hey, I tried not to mock, and I got sick of initing all the dependencies</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

		</div>
			<div>
			<div class="entry__content">
				<p>Well, probably <em>you</em> are not, but let me grumble a little bit anyway.</p>
<p><figure class="post__image">
	<img 
	itemprop="image"
	class="lazyload post__image" 
    data-sizes="auto"
    src="/img/placeholder.svg"
    data-src='/images/2017-12-mocking/mockingbird.jpg'
    alt='Mockingbird picture'
     title="Mockingbird picture"
 	/>
</figure>

<em>Mockingbird knows how to mock.</em></p>
<p>I&rsquo;ve been working with various code bases throughout of my career, and there is one pattern which I see rather often. As you may have already guessed it&rsquo;s the unit-tests and mocking I&rsquo;m going to talk about here. To give it a nice catchy start, I&rsquo;d claim here, that mocks should be used when you <em>have to</em>, but not when you <em>can</em>.</p>
<p>I&rsquo;ll give a few examples of somewhat useless and even harmful tests.<br>
All the examples are going to be made up, but I hope you&rsquo;d get the point.</p>
<p>So, let&rsquo;s start with the typical <code>Greeter</code> example. This is a &ldquo;Hello, world&rdquo; of Unit Testing. In one way or another, this sample gets repeated in all the articles, posts and books dedicated to unit-tests and mocking frameworks.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">IGreeter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">string</span> <span class="n">Greet</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">title</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Greeter</span><span class="p">:</span> <span class="n">IGreeter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span> <span class="kt">string</span> <span class="n">Greet</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">title</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;Hello,&#34;</span> <span class="p">+</span> <span class="n">title</span> <span class="p">+</span> <span class="s">&#34; &#34;</span> <span class="p">+</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">private</span> <span class="n">IGreeter</span> <span class="n">_greeter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span> <span class="n">Client</span><span class="p">(</span><span class="n">IGreeter</span> <span class="n">greeter</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">_greeter</span> <span class="p">=</span> <span class="n">greeter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">public</span> <span class="kt">string</span> <span class="n">FormatPageHeader</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">title</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;&lt;h&gt;&#34;</span> <span class="p">+</span>  <span class="n">_greeter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="p">+</span> <span class="s">&#34;&lt;/h&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">public</span> <span class="k">class</span> <span class="nc">ClientTests</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pubic</span> <span class="k">void</span> <span class="n">Test</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">mock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IGreeter</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">mock</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">greeter</span> <span class="p">=&gt;</span> <span class="n">greeter</span><span class="p">.</span><span class="n">Greet</span><span class="p">(</span><span class="s">&#34;John&#34;</span><span class="p">,</span> <span class="s">&#34;Mr.&#34;</span><span class="p">)).</span><span class="n">Returns</span><span class="p">(</span><span class="s">&#34;Hello, Mr. John&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Client</span><span class="p">(</span><span class="n">mock</span><span class="p">.</span><span class="n">Object</span><span class="p">).</span><span class="n">FormatPageHeader</span><span class="p">(</span><span class="s">&#34;John&#34;</span><span class="p">,</span> <span class="s">&#34;Mr.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEquals</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#34;&lt;h&gt;Hello, Mr. John&lt;/h&gt;&#34;</span><span class="p">);</span> <span class="c1">//All good here, what does it test, tho?</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div><p>So far so good. Tests are green. The Greeter interface isn&rsquo;t perfect, though. Two <code>strings</code> as a parameter? So easy to mess up, isn&rsquo;t it? Most probably you have a method like that in your project.</p>
<p>Ok then, imagine that you decided to make this method less error prone. You don&rsquo;t have much time for a proper refactoring because you have a feature to work on. Let&rsquo;s just swap the parameters. It&rsquo;s much more natural for a human to put the title before the name. Depends on the culture, I know.</p>
<p>(&ldquo;John&rdquo;, &ldquo;Mr.&rdquo;) is more awkward compared to (&ldquo;Mr.&rdquo;, &ldquo;John&rdquo;) and (&ldquo;Dr.&rdquo;, &ldquo;Smith&rdquo;).</p>
<p>So, we&rsquo;ll end up with the greeter like that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="c1">//Version 2</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Greeter2</span> <span class="p">:</span> <span class="n">IGreeter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span> <span class="kt">string</span> <span class="n">Greet</span><span class="p">(</span><span class="kt">string</span> <span class="n">title</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;Hello, &#34;</span> <span class="p">+</span> <span class="n">title</span> <span class="p">+</span> <span class="s">&#34; &#34;</span> <span class="p">+</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IGreeter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">string</span> <span class="n">Greet</span><span class="p">(</span><span class="kt">string</span> <span class="n">title</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>add.</code>, <code>commit</code>, <code>push</code>.  Our beloved build server will pick the changes up, will run the tests and will fail of course. We forgot to update the test for the <code>IGreeter</code> implementation. Once they fixed we&rsquo;re good, aren&rsquo;t we?</p>
<p>Not really, remember the <code>Client</code> class? Now it&rsquo;s incorrect, we still pass the title and the name in the old order, even though our test claims that everything is fine.</p>
<p><figure class="post__image">
	<img 
	itemprop="image"
	class="lazyload post__image" 
    data-sizes="auto"
    src="/img/placeholder.svg"
    data-src='/images/2017-12-mocking/fine.jpg'
    alt='This is fine'
     title="This is fine"
 	/>
</figure>
</p>
<p>Here is the paradox, we introduced mocking so that we can test our class in isolation, but we had to put some code to make that mock return something. It&rsquo;s still the logic, isn&rsquo;t it? Now <code>IGreeter</code> has at least two implementations. Most probably in your codebase, you have tens of implementations for the mocked class. Just because it&rsquo;s a very much reused dependency, and you have to mock it all over again.</p>
<p>We can improve that test, tune it, but the only way we can make it fail is to repeat the <code>Greeter</code> logic in our mock set up. But wait a minute, if we have the same implementation, why don&rsquo;t we reuse the existing code?</p>
<p>The more complex your mocked object is the more complex your mock setup becomes. If that&rsquo;s not the case, most probably you&rsquo;re testing just the interaction with your dumb mock, i.e. you&rsquo;re not testing anything. Just like the <code>ClientTest</code> above. The only positive outcome is the extra 20c which your company pays to Amazon for that CPU time you waisted on the build server.</p>
<p>It&rsquo;s not rare to have more than one dependency. I can imagine that our <code>Client</code> could use some <code>IHmlRenderer</code> which would consume the <code>IGreeter</code> result. You would mock that one too, right?</p>
<p>Sweet as. You now have a test which verifies how two mocks are integrated with each other. How does that prove your code correctness, thought? I don&rsquo;t know.</p>
<p>I&rsquo;m going to step back now, and talk about it from another point of view. What does the typical system look like? I assume, it&rsquo;s not the bunch of isolated classes, but it&rsquo;s more like a spiderweb of dependencies. If you look at type dependency diagram you would see a group of clusters, where each cluster is a somewhat tightly coupled set of classes. This is how we manage complexity, we break down one large class into small pieces, but those pieces would never be used in isolation. Each of them would be responsible for a little piece of work. You would write a separate test suite for them, mock out all the dependencies (they all belong to the same cluster).</p>
<p>How is that different to the attempt to <a href="https://stackoverflow.com/questions/34571/how-do-i-test-a-private-function-or-a-class-that-has-private-methods-fields-or" target="_blank" rel="noopener">test a private method</a>?</p>
<p>That little convenience wrapper for the standard library class is nothing more than an implementation detail.</p>
<h3 id="but-integration-tests-are-slow" itemprop="headline" class="heading">But integration tests are slow&hellip; <a class="anchor-link" href="#but-integration-tests-are-slow">#</a></h3>
<p>That would be an expected note. If we come back to our <code>ClientTest</code>. What performs better, the test with mock, or the test with the concrete Greeter implementation? I guess the answer is obvious. We shouldn&rsquo;t forget that that test doesn&rsquo;t prove anything. It is slower, it allocates more, and it&rsquo;s wrong. I&rsquo;d say it&rsquo;s harmful.</p>
<h3 id="so-youre-going-to-send-out-those-emails-every-time-you-test" itemprop="headline" class="heading">So you&rsquo;re going to send out those emails every time you test? <a class="anchor-link" href="#so-youre-going-to-send-out-those-emails-every-time-you-test">#</a></h3>
<p>Ok, that is a good question. Remember I said that we should mock when we <em>have to</em>, not when we <em>can</em>? That&rsquo;s exactly the right situation for the test isolation.</p>
<p>You don&rsquo;t want to make HTTP calls while running your unit tests suite, you don&rsquo;t want to send out emails, neither do I.</p>
<h3 id="hey-i-tried-not-to-mock-and-i-got-sick-of-initing-all-the-dependencies" itemprop="headline" class="heading">Hey, I tried not to mock, and I got sick of initing all the dependencies <a class="anchor-link" href="#hey-i-tried-not-to-mock-and-i-got-sick-of-initing-all-the-dependencies">#</a></h3>
<p>This is where it gets painful. I saw systems like that, it&rsquo;s a nightmare to maintain. Manually setting up the dependency of the dependency is really not the way to go. It&rsquo;s hard, and everyone would avoid writing a new test. But that&rsquo;s an easy task to solve.</p>
<p>How do we build a dependency tree in the runtime? I hope you&rsquo;re using the DI framework which wires up interfaces and implementations together, it knows how to create a new dependency, it knows when and how to rebuild a dependency tree. If you&rsquo;re building a web service you should reset the state between requests, so keep as many dependencies request scoped as it&rsquo;s possible.</p>
<p>The same pattern is applicable for your test suite. Everything is request scoped and stateless already, so treat each test as a &lsquo;request&rsquo; and let the DI container to build the system under test for you.</p>
<p>Of course, you would have to set up the DI container differently.</p>
<p>Module (or cluster) level test would build the dependency tree for that module but would mock out the rest of the world. Like no HTTP calls, no DB, no emails, you&rsquo;ve got the point.</p>
<p>At this point, you would realize that you don&rsquo;t need that test which verifies that your utility class can split the string, but you would be sure that your <code>MortgageCalculator</code> does the job. After all, that is your business rule, and that is the feature you&rsquo;re building. Unless you are the low-level framework developer of course. Most of us are not, though.</p>
<p>Once you&rsquo;ve got all the clusters well tested, all the interfaces established you may try to break it down a little bit. Or you may want to leave it as is, it&rsquo;s up to you.</p>
<p>Imagine you want to extract some logic into the separate class. Now your system has a new dependency, but that logic has already been tested. You don&rsquo;t need to set up a new mock, you don&rsquo;t need to repeat the logic of the extracted class in your test set up, you don&rsquo;t need to update the test to instantiate the tested class. It&rsquo;s just there, and your safety net still works. If you extract and modify the logic, you would break the test.  Do you see the beauty? Extracting the class and introducing a new dependency is as easy as moving the logic into a private method.</p>
<h3 id="summary" itemprop="headline" class="heading">Summary <a class="anchor-link" href="#summary">#</a></h3>
<p>The approach above would give you the following benefits:</p>
<ul>
<li>Fewer meaningful, useless and harmful tests</li>
<li>No need to maintain duplicated implementation (mock set ups)</li>
<li>Feature driven tests, tests that verify that the cluster does the job</li>
<li>An easy to refactor code base</li>
<li>You can improve module level access (no need to make the class public just for the testing)</li>
</ul>
<p>From my experience tests, based on that cluster approach, are much more reliable. When they break, they actually mean that the system is dysfunctional, when they pass you can be sure that you did not break the logic.</p>
<p>We still have to run integration tests to be sure that the third party integrations are working, that the system&rsquo;s runtime configuration is valid.</p>
<p>I am more than open to any criticism, feel free to tear that post apart.</p>

				

				

			</div>
			
			<div class="entry__footer">
				
<div class="post__tag">
			<a href="/tags/programming/"># programming</a>
</div>
				
				

			</div>
			
			</div>
		</div>
	</article>
	<div class="wrapper">
		



	</div>
	

		</main>
		<footer class="footer">
<div class="footer__social">
		<a itemprop="sameAs" class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/return_true">
			<svg class="social__icon" aria-label="Twitter" viewBox="0 0 24.999 20.316"><path d="M25 2.405a10.253 10.253 0 0 1-2.947.808A5.144 5.144 0 0 0 24.308.376 10.27 10.27 0 0 1 21.05 1.62a5.134 5.134 0 0 0-8.74 4.68A14.56 14.56 0 0 1 1.74.94a5.134 5.134 0 0 0 1.587 6.846 5.108 5.108 0 0 1-2.323-.642v.064a5.132 5.132 0 0 0 4.114 5.03 5.142 5.142 0 0 1-2.316.088 5.134 5.134 0 0 0 4.79 3.562 10.29 10.29 0 0 1-6.37 2.2A10.44 10.44 0 0 1 0 18.012a14.586 14.586 0 0 0 22.454-12.29q0-.333-.015-.662A10.423 10.423 0 0 0 25 2.405z" /></svg>

		</a>
		<a itemprop="sameAs" class="social__link" target="_blank" rel="noopener noreferrer" href="https://linkedin.com/in/sizikov">
			<svg class="social__icon" aria-label="LinkedIn" role="img" viewBox="0 0 34.48 32"><path d="M29.632,0H2.362A2.336,2.336,0,0,0,0,2.306V29.691A2.337,2.337,0,0,0,2.362,32h27.27A2.342,2.342,0,0,0,32,29.691V2.306A2.34,2.34,0,0,0,29.632,0ZM9.491,27.268H4.744V12H9.491ZM7.119,9.909a2.752,2.752,0,1,1,2.75-2.753A2.753,2.753,0,0,1,7.119,9.909ZM27.268,27.268H22.525V19.842c0-1.772-.033-4.05-2.466-4.05-2.47,0-2.848,1.929-2.848,3.921v7.555H12.468V12h4.553v2.086h.063a4.986,4.986,0,0,1,4.491-2.467c4.806,0,5.694,3.163,5.694,7.275Z"/></svg>

		</a>
		<a itemprop="sameAs" class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/asizikov">
			<svg class="social__icon" aria-label="Github" role="img" viewBox="0 0 25 25"><path d="m12 .5c-6.63 0-12 5.28-12 11.792 0 5.211 3.438 9.63 8.205 11.188.6.111.82-.254.82-.567 0-.28-.01-1.022-.015-2.005-3.338.711-4.042-1.582-4.042-1.582-.546-1.361-1.335-1.725-1.335-1.725-1.087-.731.084-.716.084-.716 1.205.082 1.838 1.215 1.838 1.215 1.07 1.803 2.809 1.282 3.495.981.108-.763.417-1.282.76-1.577-2.665-.295-5.466-1.309-5.466-5.827 0-1.287.465-2.339 1.235-3.164-.135-.298-.54-1.497.105-3.121 0 0 1.005-.316 3.3 1.209.96-.262 1.98-.392 3-.398 1.02.006 2.04.136 3 .398 2.28-1.525 3.285-1.209 3.285-1.209.645 1.624.24 2.823.12 3.121.765.825 1.23 1.877 1.23 3.164 0 4.53-2.805 5.527-5.475 5.817.42.354.81 1.077.81 2.182 0 1.578-.015 2.846-.015 3.229 0 .309.21.678.825.56 4.801-1.548 8.236-5.97 8.236-11.173 0-6.512-5.373-11.792-12-11.792z" /></svg>

		</a>
</div>
	<div class="footer__copyright">¬© 2022 <a href="https://blog.cloud-eng.nl">Anton Sizikov</a> <span class="footer__copyright-credits"></span> | Created with ‚ù§Ô∏è <a href="//gohugo.io">Hugo</a></div>
</footer>
	</div>
	



<script type="text/javascript" src="/js/bundle.min.js" defer></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.0/lazysizes.min.js"></script>
<script>(function (d, e) { d[e] = d[e].replace("no-js", "js"); })(document.documentElement, "className");</script>
<script>
    
    
    
        (function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m) })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); ga('create', 'UA-64347270-1', 'auto'); ga('send', 'pageview');
    

    
    
    
    

    if ('serviceWorker' in navigator) {
        const buildDate = "11/27/22";
        navigator.serviceWorker
            .register("https://blog.cloud-eng.nl/sw.js", { scope: '/' })
            .then(function (registration) {
                console.log('Service Worker Registered');
            });

        navigator.serviceWorker
            .ready
            .then(function (registration) {
                console.log('Service Worker Ready');
            });
    }
</script>

</body>

</html>
