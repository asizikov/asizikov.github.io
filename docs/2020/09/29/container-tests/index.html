<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="index,follow" name="googlebot">
	<meta content="follow, all" name="Googlebot-Image">
	<meta content="follow, all" name="Scooter">
	<meta content="follow, all" name="msnbot">
	<meta content="follow, all" name="alexabot">
	<meta content="follow, all" name="Slurp">
	<meta content="follow, all" name="ZyBorg">
	<meta content="follow, all" name="Scooter">
	<meta content="true" name="MSSmartTagsPreventParsing">
	<meta content="ALL" name="SPIDERS">
	<meta content="ALL" name="WEBCRAWLERS">
	<meta
		content="aeiwi, alexa, alltheWeb, altavista, aol netfind, anzwers, canada, directhit, euroseek, excite, overture, go, google, hotbot. infomak, kanoodle, lycos, mastersite, national directory, northern light, searchit, simplesearch, Websmostlinked, webtop, what-u-seek, aol, yahoo, webcrawler, infoseek, excite, magellan, looksmart, bing, cnet, googlebot"
		name="search engines">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	
<title>Docker image tests | Anton Sizikov</title>

    <link rel="stylesheet" href="/css/main.css">


    <link rel="stylesheet" href="/css/custom.css">


      <script src="/js/main.js"></script>


</head>
<body>
  <header>
    <div class="international__typo__header__layout">
    <div class="international__typo__header__layout__left">
        <span class="international__typo__header__layout_subdomain">
            <a class="international__typo__header__home" href="/">blog.</a></span>
    </div>
    <div class="international__typo__header__layout__right">
        <span class="international__typo__header__layout__right__domain">cloud-eng</span>
        <span class="international__typo__header__layout__right__tld">.nl</span>
    <div>                        
</div>



  </header>
  <main>
    <div class="international__typo__main__layout">
      <div class="international__typo__main__layout__left"></div>
      <div class="international__typo__main__layout__right">
        <div class="international__typo__main__layout__right__content">
        
<div class="international__typo__post__content">
  <h1>Docker image tests</h1>

  
  
  
  <p class="international__typo__post__date">
    Published on <time datetime="2020-09-29T00:00:00&#43;00:00">September 29, 2020</time>
  </p>

  <p>Today we&rsquo;re going to set up a CI/CD GitHub Action with a Container Structure Test step which will help us to enforce the certain quality policies for the images which we build and ship.</p>
<p>It&rsquo;s a good idea to review your docker images. First of all, it can save time, disk space, and money.</p>
<p>When our images are lean the build time is reduced as well as the pull and startup time. Local Docker cache takes less space. And as a cherry on the cake, we pay less for our cloud storage and egress/cross-region/cross-az traffic.</p>
<p>A win-win-win situation.</p>
<p>We also should take care of the content of our images because we don&rsquo;t need to provide a broader attack surface. Fewer tools installed means fewer opportunities for those zero-days exploits.</p>
<p>And last, but not least everyone who can pull our can inspect them (tools like <a href="https://github.com/wagoodman/dive">dive</a> can make this process easy as pie).</p>
<p><img src="/images/2020-09-container-tests/dive.png" alt="Dive PNG screenshot"></p>
<p>So it makes sense to reject images with sensitive data/information baked in the layer.</p>
<h2 id="container-structure-test">Container Structure Test</h2>
<p>There are several tools that are available to help us enforce policies on the images that we build and deploy. One of them is a framework called <a href="https://github.com/GoogleContainerTools/container-structure-test">Container Structure Tests</a></p>
<p>The Container Structure Tests provide a framework to validate the structure of a container image. These tests can be used to check the output of commands in an image, as well as verify metadata and contents of the filesystem.</p>
<p>Tests can be run either through a standalone binary or through a Docker image.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">container-structure-test <span class="nb">test</span> --image gcr.io/registry/image:latest <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--config config.yaml
</span></span></code></pre></div><p>Let&rsquo;s check a few examples.</p>
<h2 id="bad-docker-image">Bad Docker image</h2>
<p>I&rsquo;m going to use <a href="https://github.com/asizikov/asp-net-container">this repository</a> as an example. Feel free to fork it and play with it yourself.</p>
<p>Let&rsquo;s review the docker file first:</p>
<script src="https://gist.github.com/asizikov/05bc249e0c6ecbd66a85b9da89427c20.js"></script>

<p>Everything is wrong about it:</p>
<ul>
<li>All the files are transferred to the docker daemon</li>
<li>.NET Core SDK is shipped to production</li>
<li>Unit tests are shipped as well</li>
<li>Many useless layers</li>
<li>Large image size</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker images
</span></span><span class="line"><span class="cl">REPOSITORY           TAG       SIZE
</span></span><span class="line"><span class="cl">asp-net-container    latest    850MB
</span></span></code></pre></div><p>850 MB for a super basic echo application. Let&rsquo;s get those things fixed.</p>
<h2 id="local-setup">Local setup</h2>
<p>At first, I&rsquo;m going to install container-structure-tests locally.</p>
<h3 id="linux">Linux</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -LO <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="o">&amp;&amp;</span> chmod +x container-structure-test-linux-amd64 <span class="o">&amp;&amp;</span> <span class="se">\ </span>
</span></span><span class="line"><span class="cl">sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
</span></span></code></pre></div><h3 id="macos">MacOS</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -LO <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>https://storage.googleapis.com/container-structure-test/latest/container-structure-test-darwin-amd64 <span class="o">&amp;&amp;</span> <span class="se">\ </span>
</span></span><span class="line"><span class="cl">chmod +x container-structure-test-darwin-amd64 <span class="o">&amp;&amp;</span> <span class="se">\ </span>
</span></span><span class="line"><span class="cl">sudo mv container-structure-test-darwin-amd64 /usr/local/bin/container-structure-test
</span></span></code></pre></div><p>And let&rsquo;s create <code>container-structure-tests.yaml</code> file with the following content:</p>
<script src="https://gist.github.com/asizikov/5b35287e09341987f8abd9d4ebceec14.js"></script>

<p>This test verifies if we have <code>.git</code> directory copied over to the <code>/app</code> working directory.</p>
<p>And now we can run this (I assume that we already have an image built from our Dockerfile)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">container-structure-test <span class="nb">test</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --image asp-net-container:latest <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --config container-structure-tests.yaml 
</span></span></code></pre></div><p><img src="/images/2020-09-container-tests/git-test.png" alt="The first test failed"></p>
<p>This is something that can be fixed with a good <code>.dockerignore</code> file:</p>
<script src="https://gist.github.com/asizikov/146eaf6fc5a7eb20443abca93a6e3c8a.js"></script>

<p>When I measure the difference on the CI (GitHub Actions) I can see that the transferred context size is reduced from
140.3kB down to 23.55kB. The local difference is even more remarkable because I have packages, DLLs, and other obj content.</p>
<h2 id="image-size-and-sdks">Image size and SDKs</h2>
<p>Container Structure Tests support so-called <code>commandTests</code>. They are the tests that can execute any CLI tool of your choice against your container and verify the produced output.</p>
<p>The syntax is pretty basic and somewhat limited. Tho we can still express our desires.</p>
<p>We want our image to satisfy the following policies:</p>
<ul>
<li>No .NET Core SDK installed</li>
<li>.NET Core runtime should be installed and registered</li>
<li>No unit tests .dlls should be shipped</li>
</ul>
<p>Let&rsquo;s turn these requirements into tests:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">commandTests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;.NET Core runtime installed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;which&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">dotnet]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">expectedOutput</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/usr/bin/dotnet&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;no SDK installed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;dotnet&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;--list-sdks&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">excludedOutput</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;.*/sdk]*&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;no test dlls present&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;find&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/app&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-name&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;*.Tests.dll&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">excludedOutput</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;.*.Tests.dll*&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>The first test executes <code>which</code> command and checks the standard output content with the provided string (this string is treated as a RegEx btw). This test will pass on the first run, so I can&rsquo;t call that a TDD approach, heh.</p>
<p>The second test runs the <code>dotnet --list-sdks</code> command and verifies that there are no matches in the output.</p>
<p>And the last one runs the <code>find</code> command which looks up for <code>*.Tests.dll</code> in the <code>/app</code> directory.</p>
<p>To fix the second test, we should use a <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage build</a> approach.</p>
<p>That will allow us to build and test our code in one container and then ship and run in another.</p>
<p>And the test dlls could be excluded by this <a href="https://github.com/dotnet/sdk/blob/3704d0ae1e75166204f2ea154c37ca89097dc97d/src/Tasks/Microsoft.NET.Build.Tasks/targets/Microsoft.NET.Publish.targets#L63-L65">little fix</a> to the <code>.csproj</code> file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">  <span class="nt">&lt;PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;TargetFramework&gt;</span>netcoreapp3.1<span class="nt">&lt;/TargetFramework&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;IsPublishable&gt;</span>false<span class="nt">&lt;/IsPublishable&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;IsPackable&gt;</span>false<span class="nt">&lt;/IsPackable&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/PropertyGroup&gt;</span>
</span></span></code></pre></div><h2 id="metadata-tests">Metadata tests</h2>
<p><code>metadataTests</code> can help us to ensure that the necessary environment variables are set, that our image has labels, the needed ports are exposed and the working directory is set correctly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">metadataTest</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;ASPNETCORE_URLS&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;http://+:80&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;DOTNET_RUNNING_IN_CONTAINER&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;org.opencontainers.image.authors&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://github.com/asizikov&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;org.opencontainers.image.source&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/app&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exposedPorts</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;80&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>(I&rsquo;m using label <a href="https://github.com/opencontainers/image-spec/blob/master/annotations.md#pre-defined-annotation-keys">naming schema</a> by <a href="https://opencontainers.org/">Open Container Initiative</a>)</p>
<h2 id="automate-all-the-things">Automate all the things!</h2>
<p>As soon as we have a successful tests run locally</p>
<p><img src="/images/2020-09-container-tests/green-tests-local.png" alt="Green tests locally"></p>
<p>it&rsquo;s time to put things together and update our GitHub Actions workflow file.</p>
<p>I&rsquo;m going to use the <a href="https://github.com/marketplace/actions/container-structure-test-action">Container Structure Test Action</a> here.</p>
<p>which is extremely easy to use: provide it with a name of your image or a <code>tar</code> file with the image export results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">run structure tests</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">plexsystems/container-structure-test-action@v0.1.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">my-image:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="l">tests.yaml</span><span class="w">
</span></span></span></code></pre></div><p>The final action file would look like that:</p>
<script src="https://gist.github.com/asizikov/a8092cfaf780b5ff48549041c31134f9.js"></script>

<p>and the fixed Dockerfile is <a href="https://github.com/asizikov/asp-net-container/blob/a1d35e57503479e68563f4c8bc1182f985b7028e/Dockerfile.fixed">here</a>.</p>
<p>What could be better than a green CI pipeline?</p>
<p><img src="/images/2020-09-container-tests/ci-green.png" alt="CI is green"></p>
<p>PS: while fixing our tests we also reduced the size of our image. Now its size is just 208Mb. A nice side benefit, eh?</p>

  
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/docker/">Docker</a></li>
        <li><a href="/tags/devops/">Devops</a></li>
    </ul>
  </div>

</div>

        </div>
      </div>
    </div>    
  </main>
  <footer>
    <p>Copyright 2025. All rights reserved.</p>

  </footer>
</body>
<script>(function (d, e) { d[e] = d[e].replace("no-js", "js"); })(document.documentElement, "className");</script>
<script>
    
    
    
        (function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m) })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); ga('create', 'UA-64347270-1', 'auto'); ga('send', 'pageview');
    

    
    
    
    

    if ('serviceWorker' in navigator) {
        const buildDate = "12/10/25";
        navigator.serviceWorker
            .register("http://localhost:1313/sw.js", { scope: '/' })
            .then(function (registration) {
                console.log('Service Worker Registered');
            });

        navigator.serviceWorker
            .ready
            .then(function (registration) {
                console.log('Service Worker Ready');
            });
    }
</script>
</html>
