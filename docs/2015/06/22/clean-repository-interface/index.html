<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<meta content="index,follow" name="googlebot">
	<meta content="follow, all" name="Googlebot-Image">
	<meta content="follow, all" name="Scooter">
	<meta content="follow, all" name="msnbot">
	<meta content="follow, all" name="alexabot">
	<meta content="follow, all" name="Slurp">
	<meta content="follow, all" name="ZyBorg">
	<meta content="follow, all" name="Scooter">
	<meta content="true" name="MSSmartTagsPreventParsing">
	<meta content="ALL" name="SPIDERS">
	<meta content="ALL" name="WEBCRAWLERS">
	<meta
		content="aeiwi, alexa, alltheWeb, altavista, aol netfind, anzwers, canada, directhit, euroseek, excite, overture, go, google, hotbot. infomak, kanoodle, lycos, mastersite, national directory, northern light, searchit, simplesearch, Websmostlinked, webtop, what-u-seek, aol, yahoo, webcrawler, infoseek, excite, magellan, looksmart, bing, cnet, googlebot"
		name="search engines">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	
<title>Keeping the repository interface clean | Anton Sizikov</title>

    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


</head>
<body>
  <header>
    <div class="international__typo__header__layout">
    <div class="international__typo__header__layout__left">
        <span class="international__typo__header__layout_subdomain">
            <a class="international__typo__header__home" href="/">blog.</a></span>
    </div>
    <div class="international__typo__header__layout__right">
        <span class="international__typo__header__layout__right__domain">cloud-eng</span>
        <span class="international__typo__header__layout__right__tld">.nl</span>
    <div>                        
</div>



  </header>
  <main>
    <div class="international__typo__main__layout">
      <div class="international__typo__main__layout__left"></div>
      <div class="international__typo__main__layout__right">
        <div class="international__typo__main__layout__right__content">
        
<div class="international__typo__post__content">
  <h1>Keeping the repository interface clean</h1>

  
  
  <h2>Published on: 
  <time datetime="2015-06-22T00:00:00&#43;00:00">June 22, 2015</time></h2>

  <p>The repository pattern is being blamed quite often. The most popular reason for that is an uncontrolled growth of the interface.</p>
<p>In the simple scenario we have an interface like this one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="k">interface</span> <span class="nc">IClientRepository</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">Client</span> <span class="n">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">GetAll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span></span></span></code></pre></div>
<p>However models are never that simple and every client might have orders, addresses, contact details, and other nested properties.</p>
<p>We don&rsquo;t want to load our database with unnecessary joins and <a href="https://msdn.microsoft.com/en-us/data/jj574232.aspx">Entity Framework has a nice tool for that</a>.</p>
<p>When we need to retrieve only client&rsquo;s orders we can include it into the query:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Orders</span><span class="p">);</span></span></span></code></pre></div>
<p>When we need just addresses:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Addresses</span><span class="p">);</span></span></span></code></pre></div>
<p>And the combination:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Orders</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Addresses</span><span class="p">);</span></span></span></code></pre></div>
<p>However the IClientRepository grows exponentially and quickly becomes an ugly monster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="k">interface</span> <span class="nc">IClientRepository</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">Client</span> <span class="n">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">Client</span> <span class="n">GetWithOrders</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">Client</span> <span class="n">GetWithAddresses</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">Client</span> <span class="n">GetWithOrdersAndAddresses</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">GetAll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span></span></span></code></pre></div>
<p>It&rsquo;s not a nice solution for sure: lot&rsquo;s of code duplication and very unclear interface.</p>
<p>A typical way to avoid it is to use <a href="https://martinfowler.com/bliki/CQRS.html">CQRS</a> pattern and encapsulate the logic into the Query object.</p>
<p>At my current project we&rsquo;re building microservices, and a CQRS looks like an overkill. It doesn&rsquo;t stop us from borrowing some ideas, though.
Let&rsquo;s remove all these GetXXXX methods and add one more parameter to the Get method.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="k">interface</span> <span class="nc">IClientRepository</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">Client</span> <span class="n">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">fetchPaths</span> <span class="p">=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">GetAll</span><span class="p">(</span><span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">fetchPaths</span> <span class="p">=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> </span></span></code></pre></div>
<p>The FetchPath is a simple generinc class which holds the collection of expressions that we&rsquo;re going to use to build our chain of Include statements.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">FetchPaths</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;&gt;</span> <span class="n">Paths</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 	    <span class="k">get</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 	    <span class="kd">private</span> <span class="k">set</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="n">FetchPaths</span><span class="p">(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">path</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> 								<span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="n">path</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="n">FetchPaths</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;&gt;</span> <span class="n">paths</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">paths</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="s">&#34;paths&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">Paths</span> <span class="p">=</span> <span class="n">paths</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">public</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Concat</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="s">&#34;other&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="k">new</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Paths</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">Paths</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
<p>Now we&rsquo;re ready to declare the following static class:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">ClientFetchPaths</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">ClientFetchPaths</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Orders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Orders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Adresses</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Adresses</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">OrdersAndAddresses</span> <span class="p">=</span> <span class="n">Adresses</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">Orders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="kd">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">Adresses</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="kd">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">Client</span><span class="p">&gt;</span> <span class="n">OrdersAndAddresses</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="kd">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></p>
<p>So that we can get the clients including all the necessary child objects.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">   <span class="kt">var</span> <span class="n">clients</span> <span class="p">=</span> <span class="n">ClientRepository</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ClientFetchPaths</span><span class="p">.</span><span class="n">OrdersAndAddresses</span><span class="p">);</span></span></span></code></pre></div>
<p>I want to mention that so far we don&rsquo;t have any EntityFramework dependency here. Than means that we can keep this code (interface, models and FetchPathes) in the same assembly and reference it from the unit test project.</p>
<p>Now the repository implementation will be clean as well:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">context</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">client</span> <span class="p">=&gt;</span> <span class="n">client</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">.</span><span class="n">Fetch</span><span class="p">(</span><span class="n">fetchPaths</span><span class="p">));</span></span></span></code></pre></div>
<p>Where Fetch is an extension method for IQueryable.
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">FetchExtensions</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">static</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Fetch</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
</span></span><span class="line"><span class="cl">  				<span class="k">this</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">queryable</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="na">  				[CanBeNull]</span> <span class="n">FetchPaths</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">paths</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">queryable</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="s">&#34;queryable&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">paths</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">queryable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">paths</span><span class="p">.</span><span class="n">Paths</span><span class="p">.</span><span class="n">Aggregate</span><span class="p">(</span><span class="n">queryable</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    	<span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">current</span><span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">expression</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></p>

  
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/programming/">Programming</a></li>
    </ul>
  </div>

</div>

        </div>
      </div>
    </div>    
  </main>
  <footer>
    <p>Copyright 2024. All rights reserved.</p>

  </footer>
</body>
</html>
