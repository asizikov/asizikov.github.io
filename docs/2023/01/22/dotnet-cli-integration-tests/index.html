<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Integration tests for .NET CLI tools | Anton Sizikov</title>

    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


</head>
<body>
  <header>
    <div class="international__typo__header__layout">
    <div class="international__typo__header__layout__left">
        <span class="international__typo__header__layout_subdomain">blog.</span>
    </div>
    <div class="international__typo__header__layout__right">
        <span class="international__typo__header__layout__right__domain">cloud-eng</span>
        <span class="international__typo__header__layout__right__tld">.nl</span>
    <div>                        
</div>



  </header>
  <main>
    <div class="international__typo__main__layout">
      <div class="international__typo__main__layout__left"></div>
      <div class="international__typo__main__layout__right">
        <div class="international__typo__main__layout__right__content">
        
<div class="international__typo__post__content">
  <h1>Integration tests for .NET CLI tools</h1>

  
  
  <h2>Published on: 
  <time datetime="2023-01-22T00:00:00&#43;00:00">January 22, 2023</time></h2>

  <p>I&rsquo;ve spent Saturday evening working on a small project. I&rsquo;ve built a .NET clone of <code>tree</code> utitly. You know, the one that renders a nice tree view for a given directory.</p>
<p>The project is available on GitHub under the <a href="https://github.com/asizikov/dtree">dtree</a> name. It&rsquo;s a .NET global tool that you can install with the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dotnet tool install -g dtree
</span></span></code></pre></div><p>The tool is pretty simple. It takes a path to a directory as an argument and renders a tree view for it. Here is an example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dtree -a
</span></span><span class="line"><span class="cl">ğŸ“ .
</span></span><span class="line"><span class="cl">â”œâ”€â”€ ğŸ“ .devcontainer
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ devcontainer.json
</span></span><span class="line"><span class="cl">â”œâ”€â”€ ğŸ“ .github
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ ğŸ“ workflows
</span></span><span class="line"><span class="cl">â”‚      â””â”€â”€ build-and-publish.yml
</span></span><span class="line"><span class="cl">â”œâ”€â”€ ğŸ“ src
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ dtree.csproj
</span></span><span class="line"><span class="cl">â”‚   â”œâ”€â”€ Program.cs
</span></span><span class="line"><span class="cl">â”‚   â””â”€â”€ TreeNode.cs
</span></span><span class="line"><span class="cl">â”œâ”€â”€ .gitignore
</span></span><span class="line"><span class="cl">â”œâ”€â”€ LICENSE
</span></span><span class="line"><span class="cl">â””â”€â”€ README.md
</span></span></code></pre></div><p>The codebase is quite hacky. It&rsquo;s a single file with top level statements. Not much abstractions over the <code>System.Console</code> and <code>System.IO.Directory</code> libraries. However, I wanted to make sure that it works as expected. So, I&rsquo;ve added a few integration tests to the project.</p>
<p>I wanted to build tests that run the compiled tool and compare the output with the expected result. One would expect to have something similar to ASP.NET <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1?view=aspnetcore-7.0">WebApplicationFactory</a>. However, there is no such thing for .NET CLI tools. So, I had to come up with a solution.</p>
<p>I&rsquo;ve created a new project, that won&rsquo;t reference the <code>dtree</code> project directly. Instead, it will use the <code>CliRunner</code> wrapper around <code>Process</code> object that will execute <code>dotnet run</code> command to compile and run the <code>dtree</code> tool.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">dtree.IntegrationTests</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">CliRunner</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">cliProjectPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">Process</span> <span class="n">process</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CliRunner</span><span class="p">(</span><span class="kt">string</span> <span class="n">cliProjectPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">cliProjectPath</span> <span class="p">=</span> <span class="n">cliProjectPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">process</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Process</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">process</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="s">&#34;dotnet&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">process</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">UseShellExecute</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">process</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">RedirectStandardOutput</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="p">(</span><span class="kt">int</span> <span class="n">exitCode</span><span class="p">,</span> <span class="kt">string</span> <span class="n">output</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="kt">string</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">process</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">=</span> <span class="s">$&#34;run --project {cliProjectPath} -- {args}&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">process</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">output</span> <span class="p">=</span> <span class="n">process</span><span class="p">.</span><span class="n">StandardOutput</span><span class="p">.</span><span class="n">ReadToEnd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">process</span><span class="p">.</span><span class="n">WaitForExit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="n">ExitCode</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And this wrapper can be used in tests.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">Xunit.Abstractions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">dtree.IntegrationTests</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DTreeTests</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">cliProjectPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">CliRunner</span> <span class="n">runner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DTreeTests</span><span class="p">(</span><span class="n">ITestOutputHelper</span> <span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cliProjectPath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="n">GetCurrentDirectory</span><span class="p">(),</span> <span class="s">&#34;../../../../src/dtree.csproj&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;{cliProjectPath}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">runner</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CliRunner</span><span class="p">(</span><span class="n">cliProjectPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Theory]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [InlineData(&#34;-d&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [InlineData(&#34;--max-depth&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Negative_Depth_Results_As_Error</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="p">(</span><span class="n">exitCode</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="p">=</span> <span class="n">runner</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="s">$&#34;{key} -1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="s">$&#34;ğŸ˜± Max depth must be greater than 0{Environment.NewLine}&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">exitCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Theory]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [InlineData(&#34;-a&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="na">    [InlineData(&#34;--all&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">All_Files_Should_Be_Included</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="kt">var</span> <span class="p">(</span><span class="n">exitCode</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="p">=</span> <span class="n">runner</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="s">$&#34;{key} -p ../../../../&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#34;ğŸ“ .devcontainer&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#34;ğŸ“ .github&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#34;ğŸ“ src&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#34;.gitignore&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#34;LICENSE&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&#34;README.md&#34;</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">exitCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This way I can run the tests in CI</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ğŸ“¥ Checkout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ğŸ§ª Execute Unit Tests</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">dotnet test ./tests</span><span class="w">
</span></span></span></code></pre></div><p>And be sure to publish the package to <a href="https://www.nuget.org/packages/dtree">NuGet</a> if everything goes well.</p>
<p>Give it a try ğŸ™‚</p>

  
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/github-actions/">Github-Actions</a></li>
        <li><a href="/tags/dotnet/">Dotnet</a></li>
    </ul>
  </div>

</div>

        </div>
      </div>
    </div>    
  </main>
  <footer>
    <p>Copyright 2024. All rights reserved.</p>

  </footer>
</body>
</html>
